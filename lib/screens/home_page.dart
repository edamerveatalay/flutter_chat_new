import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:flutter/material.dart';
import 'package:flutter_chat_new/screens/chat_page.dart';
import 'package:flutter_chat_new/screens/users_page.dart';
import 'package:intl/intl.dart';

class HomePage extends StatefulWidget {
  const HomePage({super.key});

  @override
  State<HomePage> createState() => _HomePageState();
}

class _HomePageState extends State<HomePage> {
  String formatTimestamp(Timestamp? ts) {
    if (ts == null) {
      return '...';
    } else {
      DateTime dt = ts.toDate();
      return DateFormat(
        'dd/MM/yyyy HH:mm',
      ).format(dt); //formatƒ± dd/MM/yyyy HH:mm olarak ayarladƒ±k
      //sonra bu formatƒ± dt'ye uyguladƒ±k ve string olarak d√∂nd√ºrd√ºk.
    }
  }

  final messageController = TextEditingController();
  final String _otherUidForTest =
      'DP7qX6JG4aP43eV2n2Kpb2KOb8Q2'; //test ama√ßlƒ± ba≈üka bir kullanƒ±cƒ±nƒ±n uid'si

  String _getChatId(String currentUid, String otherUid) {
    //kullanƒ±cƒ± id'lerini alƒ±p sohbet id'si olu≈üturma fonksiyonu
    //bir kere yazdƒ±k tekrar tekrar yazmamak i√ßin fonksiyon olu≈üturduk
    //uid'leri alƒ±p sohbet id'si olu≈üturacak
    final ids = [currentUid, otherUid]..sort(); //uid'leri listeye attƒ±k
    return ids.join('_'); //uid'leri birle≈ütirip sohbet id'si olu≈üturduk
  }

  _buildChat() async {
    //kullanƒ±cƒ±lar arasƒ± sohbet olu≈üturma fonksiyonu
    final String currentUid =
        FirebaseAuth.instance.currentUser!.uid; //≈üu anki kullanƒ±cƒ±nƒ±n uid'si
    //≈üu anki kullanƒ±cƒ±yƒ± alƒ±yoruz ve uid'sini yani benzersiz kimliƒüini alƒ±yoruz
    final String _otherUid = _otherUidForTest; //ba≈üka bir kullanƒ±cƒ±nƒ±n uid'si

    final chatId = _getChatId(currentUid, _otherUid); //sohbet id'si olu≈üturduk

    await FirebaseFirestore.instance.collection('chats').doc(chatId).set(
      {
        'members': [currentUid, _otherUid], //sohbetin √ºyeleri,
        'createdAt': FieldValue.serverTimestamp(), //sohbetin olu≈üturulma zamanƒ±
      },
      SetOptions(merge: true),
    ); // merge true ekledim, var ise √ºst√ºne yazmasƒ±n, eklesin

    print("chatId: $chatId");
  }

  void _signOut() async {
    //√ßƒ±kkƒ±≈ü i√ßin fonksiyon olu≈üturdum
    await FirebaseAuth.instance
        .signOut(); //bu fonksiyon firebase kullanƒ±cƒ± giri≈ü √ßƒ±kƒ±≈ü kƒ±smƒ±na eri≈üiyor ve oturumu kapatƒ±yor
    //fireBase auth'un √ßƒ±kkƒ±≈ü yapma fonksiyonunu kullanarak √ßƒ±kƒ±≈ü yapmayƒ± saƒülƒ±yoruz yani szaten onda olan fonksiyonu kullandƒ±k biz burada
  }

  @override
  Widget build(BuildContext context) {
    final currentUid = FirebaseAuth.instance.currentUser!.uid;
    //currentUser ‚Üí ≈üu an oturum a√ßmƒ±≈ü kullanƒ±cƒ±yƒ± verir
    /*Auth ‚Üí "Bu kim?" (giri≈ü yapan kullanƒ±cƒ±)

Firestore ‚Üí "Bu ki≈üiyle ilgili ne biliyoruz?" (e-posta, mesajlar, zaman bilgisi vb.) */

    return Scaffold(
      appBar: AppBar(
        title: Text('Home Page'),
        actions: [
          IconButton(
            onPressed: () {
              Navigator.push(
                context,
                MaterialPageRoute(builder: (context) => UserPage()),
              );
            },
            icon: Icon(Icons.people),
          ),
        ],
      ),

      body: Center(
        child: Column(
          children: [
            // Sohbet listesi i√ßin StreamBuilder (chats koleksiyonu)
            Expanded(
              child: StreamBuilder<QuerySnapshot>(
                stream: FirebaseFirestore.instance
                    .collection('chats')
                    .where('members', arrayContains: currentUid)
                    .snapshots(),
                builder: (context, snapshot) {
                  if (snapshot.hasError) {
                    return Text('Hata olu≈ütu: ${snapshot.error}');
                  }
                  if (snapshot.connectionState == ConnectionState.waiting) {
                    return Center(child: CircularProgressIndicator());
                  }
                  final chats = snapshot.data?.docs ?? [];

                  if (chats.isEmpty) {
                    return Center(child: Text('Hen√ºz sohbet yok'));
                  }

                  return ListView.builder(
                    itemCount: chats.length,
                    itemBuilder: (context, index) {
                      final chatDoc = chats[index];
                      final data = chatDoc.data() as Map<String, dynamic>;
                      final members = List<String>.from(
                        data['members'] ?? [],
                      ); //members deƒüi≈ükeni, o sohbet odasƒ±na dahil olan kullanƒ±cƒ±larƒ±n UID'lerinden olu≈üan bir listedir.
                      final otherUid = members.isNotEmpty
                          ? members.firstWhere(
                              (uid) => uid != currentUid,
                              orElse: () => 'Bilinmiyor',
                            )
                          : 'Bilinmiyor';
                      print("otherUid: $otherUid");

                      // Eƒüer otherUid bulunamadƒ±ysa (√∂r. tek ki≈üilik veya veri hatasƒ±) g√∂ster
                      if (otherUid == 'Bilinmiyor') {
                        return ListTile(title: Text('Kullanƒ±cƒ± bulunamadƒ±'));
                      }

                      // chat dok√ºmanƒ±nda eƒüer olu≈üturulurken kaydedilmi≈ü fallback email varsa alalƒ±m
                      final fallbackEmail = (data['otherEmail'] as String?)
                          ?.trim();

                      // üîπ Kullanƒ±cƒ± belgesini √ßek; yoksa fallbackEmail g√∂ster
                      return FutureBuilder<DocumentSnapshot>(
                        future: FirebaseFirestore.instance
                            .collection('users')
                            .doc(otherUid.trim())
                            .get(),
                        builder: (context, userSnapshot) {
                          if (userSnapshot.connectionState ==
                              ConnectionState.waiting) {
                            return ListTile(title: Text('Y√ºkleniyor...'));
                          } else if (userSnapshot.hasError) {
                            return ListTile(title: Text('Hata'));
                          }

                          String shownEmail;
                          if (!userSnapshot.hasData ||
                              !userSnapshot.data!.exists) {
                            // Eƒüer users koleksiyonunda belge yoksa chat i√ßindeki fallbackEmail'i g√∂ster
                            shownEmail = fallbackEmail ?? 'Bilinmiyor';
                          } else {
                            final userData =
                                userSnapshot.data!.data()
                                    as Map<String, dynamic>?;
                            shownEmail =
                                (userData?['email'] as String?) ??
                                (fallbackEmail ?? 'Bilinmiyor');
                          }

                          // Her sohbet satƒ±rƒ±nda son mesajƒ± g√∂stermek i√ßin messages koleksiyonunu dinle
                          return ListTile(
                            onTap: () {
                              Navigator.push(
                                context,
                                MaterialPageRoute(
                                  builder: (context) => ChatPage(
                                    chatId: chatDoc.id,
                                    otherUserEmail: shownEmail,
                                  ),
                                ),
                              );
                              print('ChatId: ${chatDoc.id}');
                            },
                            title: Text(shownEmail),
                            subtitle: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text(
                                  "Olu≈üturulma zamanƒ±: ${formatTimestamp(data['createdAt'])}",
                                ),
                                SizedBox(height: 4),

                                //her sohbet i√ßin Firestore‚Äôdaki messages koleksiyonunu dinleyip, varsa son mesajƒ± g√∂steriyor; yoksa ‚ÄúHen√ºz mesaj yok‚Äù yazƒ±yor.
                                StreamBuilder<QuerySnapshot>(
                                  stream: FirebaseFirestore.instance
                                      .collection('chats')
                                      .doc(chatDoc.id)
                                      .collection('messages')
                                      .orderBy('timestamp', descending: true)
                                      .limit(1)
                                      .snapshots(), //Buradaki verileri s√ºrekli dinleyen bir stream ba≈ülatƒ±yoruz.
                                  builder: (context, msgSnapshot) {
                                    if (msgSnapshot.connectionState ==
                                        ConnectionState.waiting) {
                                      return Text("Y√ºkleniyor...");
                                    }
                                    if (msgSnapshot.hasError) {
                                      return Text("Hata olu≈ütu");
                                    }
                                    final messages =
                                        msgSnapshot.data?.docs ?? [];

                                    if (messages.isNotEmpty) {
                                      final lastMessage = messages.first;
                                      final messageData =
                                          lastMessage.data()
                                              as Map<String, dynamic>;
                                      return Text(
                                        "Son mesaj: ${messageData['text'] ?? ''}",
                                      );
                                    } else {
                                      return Text("Hen√ºz mesaj yok");
                                    }
                                  },
                                ),
                              ],
                            ),
                          );
                        },
                      );
                    },
                  );
                },
              ),
            ),

            SizedBox(height: 20),

            SizedBox(height: 20),
            Column(
              children: [
                SizedBox(
                  width:
                      MediaQuery.of(context).size.width * 0.4, // aynƒ± geni≈ülik
                  //mediaQuery ‚Üí ekran boyutlarƒ±na eri≈ümek i√ßin kullanƒ±lƒ±r
                  //.size.width ‚Üí ekranƒ±n geni≈üliƒüini pixel cinsinden verir.
                  //* 0.4 ‚Üí bu geni≈üliƒüin %40‚Äôƒ±nƒ± alƒ±r.
                  child: ElevatedButton(
                    onPressed: _signOut,
                    child: Text('√áƒ±kƒ±≈ü Yap'),
                  ),
                ),
                SizedBox(height: 10),
                SizedBox(
                  width: MediaQuery.of(context).size.width * 0.4,
                  child: ElevatedButton(
                    onPressed: _buildChat,
                    child: Text('Sohbet Olu≈ütur'),
                  ),
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }
}

//buildChat i√ßinde kullanƒ±lan currentId ohbet odasƒ±nƒ± olu≈ütururken kullanƒ±lƒ±yor. Yani kimlerle sohbet odasƒ± a√ßƒ±lacaƒüƒ±nƒ± belirlem
//elevatedButton i√ßinde kullanƒ±lan currentId ise, mesaj g√∂nderirken kullanƒ±lƒ±yor. Yani mesajƒ±n hangi kullanƒ±cƒ± tarafƒ±ndan g√∂nderildiƒüini belirlemek i√ßin.
